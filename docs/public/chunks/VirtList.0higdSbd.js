import{p as F,a as K,b as U,O as ne}from"./ObserverItem.6qwwCos6.js";import{h as E,a7 as ee,a1 as fe,j as ae,a9 as ce,G as de,y as te,d as ue,a6 as m}from"./framework.lQqlyL6x.js";const ye={fixed:!1,buffer:0,bufferTop:0,bufferBottom:0,scrollDistance:0,horizontal:!1,start:0,offset:0,listStyle:"",listClass:"",itemStyle:"",itemClass:"",headerClass:"",headerStyle:"",footerClass:"",footerStyle:"",stickyHeaderClass:"",stickyHeaderStyle:"",stickyFooterClass:"",stickyFooterStyle:""};function Se(C,c){const e=new Proxy(C,{get(i,o){return Reflect.get(i,o)??Reflect.get(ye,o)}}),d=E(null),g=E(null),p=E(null),v=E(null),w=E(null),B=E(null),b=new Map,D=E(0);let T="backward",H=!1,I=!1;const n=ee({clientSize:0,headerSize:0,footerSize:0,stickyHeaderSize:0,stickyFooterSize:0}),t=ee({views:0,offset:0,listTotalSize:0,virtualSize:0,inViewBegin:0,inViewEnd:0,renderBegin:0,renderEnd:0,bufferTop:0,bufferBottom:0});function L(){const i=e.horizontal?"scrollLeft":"scrollTop";return d.value?d.value[i]:0}function j(){return n.headerSize+n.footerSize+n.stickyHeaderSize+n.stickyFooterSize}function _(){return t.listTotalSize+n.headerSize+n.footerSize+n.stickyHeaderSize+n.stickyFooterSize}function y(i){return e.fixed?e.minSize:b.get(String(i))??e.minSize}function G(i,o){b.set(String(i),o)}function A(i){b.delete(String(i))}function R(i){var l,u;if(e.fixed)return{top:e.minSize*i,current:e.minSize,bottom:e.minSize*(i+1)};const{itemKey:o}=e;let r=n.headerSize;for(let f=0;f<=i-1;f+=1){const h=y((l=e.list[f])==null?void 0:l[o]);r+=h}const s=y((u=e.list[i])==null?void 0:u[o]);return{top:r,current:s,bottom:r+s}}function S(i,o=!1){o&&(I=!0);const r=e.horizontal?"scrollLeft":"scrollTop";d.value&&(d.value[r]=i)}async function $(i){if(console.log("scrollToIndex",i),i<0)return;if(i>=e.list.length-1){M();return}let{top:o}=R(i);const r=async()=>{S(o),setTimeout(()=>{const{top:s}=R(i);o!==s&&(o=s,r())},3)};r()}async function P(i){var f;const{top:o,bottom:r}=R(i),s=L(),l=L()+n.clientSize,u=y((f=e.list[i])==null?void 0:f[e.itemKey]);if(o<s&&s<r&&u<n.clientSize){S(o);return}if(o+n.stickyHeaderSize<l&&l<r+n.stickyHeaderSize&&u<n.clientSize){S(r-n.clientSize+n.stickyHeaderSize);return}if(o+n.stickyHeaderSize>=l){$(i);return}if(r<=s){$(i);return}}async function q(){S(0),setTimeout(()=>{var o;const i=e.horizontal?"scrollLeft":"scrollTop";((o=d==null?void 0:d.value)==null?void 0:o[i])!==0&&q()},3)}async function M(){S(_()),setTimeout(()=>{Math.abs(Math.round(t.offset+n.clientSize)-Math.round(_()))>2&&M()},0)}function V(i){t.inViewBegin=i,t.inViewEnd=Math.min(i+t.views,e.list.length-1)}function k(){var h,O;const{views:i,offset:o,inViewBegin:r}=t,{itemKey:s}=e,l=o-n.headerSize;let u=r,f=re();if(l<0){V(0);return}if(T==="forward"){if(l>=f)return;for(let z=u-1;z>=0;z-=1){const N=y((h=e.list[z])==null?void 0:h[s]);if(f-=N,f<=l&&l<f+N){u=z;break}}H=!0}if(T==="backward"){if(l<=f)return;for(let z=u;z<=e.list.length-1;z+=1){const N=y((O=e.list[z])==null?void 0:O[s]);if(f<=l&&l<f+N){u=z;break}f+=N}H=!1}u!==t.inViewBegin&&V(u)}function x(i){var r,s,l;(r=c==null?void 0:c.scroll)==null||r.call(c,i);const o=L();o!==t.offset&&(T=o<t.offset?"forward":"backward",t.offset=o,k(),T==="forward"&&t.offset-e.scrollDistance<=0&&(console.log("[VirtList] 到达顶部"),(s=c==null?void 0:c.toTop)==null||s.call(c,e.list[0])),T==="backward"&&t.offset+e.scrollDistance>=t.listTotalSize+j()-n.clientSize&&(console.log("[VirtList] 到达底部"),(l=c==null?void 0:c.toBottom)==null||l.call(c,e.list[e.list.length-1])))}function ie(){const i=Math.ceil(n.clientSize/e.minSize)+1;t.views=i}function oe(){ie(),V(t.inViewBegin)}function W(){var r;if(e.fixed){t.listTotalSize=e.minSize*e.list.length;return}const{itemKey:i}=e;let o=0;for(let s=0;s<=e.list.length-1;s+=1)o+=y((r=e.list[s])==null?void 0:r[i]);t.listTotalSize=o}function Q(){console.log("[VirtList] reset"),t.offset=0,t.listTotalSize=0,t.virtualSize=0,t.inViewBegin=0,t.inViewEnd=0,t.renderBegin=0,t.renderEnd=0,b.clear()}function le(i){W();let o=0;i.forEach(r=>{o+=y(r[e.itemKey])}),Y(),S(t.offset-o,!0),k()}function se(i){W();let o=0;i.forEach(r=>{o+=y(r[e.itemKey])}),Y(),S(t.offset+o,!0),k()}function X(){D.value+=1}let a;typeof ResizeObserver<"u"&&(a=new ResizeObserver(i=>{var r;let o=0;for(const s of i){const l=s.target.dataset.id;if(l){const u=y(l);let f=0;if(s.borderBoxSize){const h=Array.isArray(s.contentBoxSize)?s.contentBoxSize[0]:s.contentBoxSize;f=e.horizontal?h.inlineSize:h.blockSize}else f=e.horizontal?s.contentRect.width:s.contentRect.height;l==="client"?(n.clientSize=f,oe()):l==="header"?n.headerSize=f:l==="footer"?n.footerSize=f:l==="stickyHeader"?n.stickyHeaderSize=f:l==="stickyFooter"?n.stickyFooterSize=f:u!==f&&(G(l,f),o+=f-u,(r=c==null?void 0:c.itemResize)==null||r.call(c,l,f))}}t.listTotalSize+=o,(H||I)&&o!==0&&(H=!1,I=!1,S(t.offset+o))}));const Y=()=>{var r;let i=0;const o=t.inViewBegin;for(let s=0;s<o;s++)i+=y((r=e.list[s])==null?void 0:r[e.itemKey]);t.virtualSize=i};fe(()=>{e.bufferTop?t.bufferTop=e.bufferTop:t.bufferTop=e.buffer,e.bufferBottom?t.bufferBottom=e.bufferBottom:t.bufferBottom=e.buffer}),ae(()=>{d.value&&(d.value.addEventListener("scroll",x),a==null||a.observe(d.value)),w.value&&(a==null||a.observe(w.value)),B.value&&(a==null||a.observe(B.value)),p.value&&(a==null||a.observe(p.value)),v.value&&(a==null||a.observe(v.value)),e.start?$(e.start):e.offset&&S(e.offset)}),ce(()=>{d.value&&(d.value.removeEventListener("scroll",x),a==null||a.unobserve(d.value),n.clientSize=0),w.value&&(a==null||a.unobserve(w.value),n.stickyHeaderSize=0),B.value&&(a==null||a.unobserve(B.value),n.stickyFooterSize=0),p.value&&(a==null||a.unobserve(p.value),n.headerSize=0),v.value&&(a==null||a.unobserve(v.value),n.footerSize=0)});function re(){return t.virtualSize+J(t.renderBegin,t.inViewBegin)}function J(i,o){var u;const r=Math.min(i,o),s=Math.max(i,o);let l=0;for(let f=r;f<s;f+=1)l+=y((u=e.list[f])==null?void 0:u[e.itemKey]);return l}const Z=de([]);return te(()=>[t.inViewBegin,t.inViewEnd,D.value],(i,o)=>{if(i&&o){const[r]=i,s=t.renderBegin;let l=r,u=t.inViewEnd;if(l=Math.max(0,l-t.bufferTop),u=Math.min(u+t.bufferBottom,e.list.length-1),e!=null&&e.renderControl){const{begin:f,end:h}=e.renderControl(r,t.inViewEnd);l=f,u=h}t.renderBegin=l,t.renderEnd=u,l>s?t.virtualSize+=J(l,s):t.virtualSize-=J(l,s),Z.value=e.list.slice(t.renderBegin,t.renderEnd+1)}},{immediate:!0}),te(()=>e.list.length,()=>{if(e.list.length<=0){Q();return}W(),V(t.inViewBegin),X()},{immediate:!0}),{props:e,renderList:Z,clientRefEl:d,listRefEl:g,headerRefEl:p,footerRefEl:v,stickyHeaderRefEl:w,stickyFooterRefEl:B,reactiveData:t,slotSize:n,sizesMap:b,resizeObserver:a,getOffset:L,reset:Q,scrollToIndex:$,scrollIntoView:P,scrollToTop:q,scrollToBottom:M,scrollToOffset:S,getItemSize:y,deleteItemSize:A,deletedList2Top:le,addedList2Top:se,getItemPosByIndex:R,forceUpdate:X}}const ge=ue({name:"VirtList",props:{list:{type:Array,default:()=>[]},itemKey:{type:[String,Number],required:!0},minSize:{type:Number,default:20,required:!0},renderControl:{type:Function,default:void 0},fixed:{type:Boolean,default:!1},buffer:{type:Number,default:0},bufferTop:{type:Number,default:0},bufferBottom:{type:Number,default:0},scrollDistance:{type:Number,default:0},horizontal:{type:Boolean,default:!1},start:{type:Number,default:0},offset:{type:Number,default:0},listStyle:{type:String,default:""},listClass:{type:String,default:""},itemStyle:{type:String,default:""},itemClass:{type:String,default:""},headerClass:{type:String,default:""},headerStyle:{type:String,default:""},footerClass:{type:String,default:""},footerStyle:{type:String,default:""},stickyHeaderClass:{type:String,default:""},stickyHeaderStyle:{type:String,default:""},stickyFooterClass:{type:String,default:""},stickyFooterStyle:{type:String,default:""}},setup(C,c){return Se(C,{scroll:d=>{c.emit("scroll",d)},toTop:d=>{c.emit("toTop",d)},toBottom:d=>{c.emit("toBottom",d)},itemResize:(d,g)=>{c.emit("itemResize",d,g)}})},render(){const{renderList:C,reactiveData:c,resizeObserver:e}=this,{itemKey:d,horizontal:g,listStyle:p,listClass:v,itemStyle:w,itemClass:B,headerClass:b,headerStyle:D,footerClass:T,footerStyle:H,stickyHeaderClass:I,stickyHeaderStyle:n,stickyFooterClass:t,stickyFooterStyle:L}=this.props,j=()=>this.$slots.stickyHeader?m("div",K({key:"slot-sticky-header",class:I,style:`position: sticky; z-index: 10; ${g?"left: 0":"top: 0;"} ${n}`,ref:"stickyHeaderRefEl"},{"data-id":"stickyHeader"}),[U(this.$slots.stickyHeader)]):null,_=()=>this.$slots.stickyFooter?m("div",K({key:"slot-sticky-footer",class:t,style:`position: sticky; z-index: 10; ${g?"right: 0":"bottom: 0;"} ${L}`,ref:"stickyFooterRefEl"},{"data-id":"stickyFooter"}),[U(this.$slots.stickyFooter)]):null,y=()=>this.$slots.header?m("div",K({key:"slot-header",class:b,style:D,ref:"headerRefEl"},{"data-id":"header"}),[U(this.$slots.header)]):null,G=()=>this.$slots.footer?m("div",K({key:"slot-footer",class:T,style:H,ref:"footerRefEl"},{"data-id":"footer"}),[U(this.$slots.footer)]):null,{listTotalSize:A,virtualSize:R,renderBegin:S}=c,$=()=>{var M,V;const P=[];for(let k=0;k<C.length;k+=1){const x=C[k];P.push(m(ne,K({key:x[d],class:B,style:w},{id:x[d],resizeObserver:e}),F([(V=(M=this.$slots).default)==null?void 0:V.call(M,{itemData:x,index:S+k})])))}const q=g?`will-change: width; min-width: ${A}px; display: flex; ${p}`:`will-change: height; min-height: ${A}px; ${p}`;return m("div",{ref:"listRefEl",class:v,style:q},[m("div",{style:g?`width: ${R}px; will-change: width;`:`height: ${R}px; will-change: height;`}),P])};return m("div",K({ref:"clientRefEl",class:"virt-list__client",style:"width: 100%; height: 100%; overflow: overlay;"},{"data-id":"client"}),F([j(),y(),$(),G(),_()]))}});export{ge as V,Se as u};
